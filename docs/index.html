<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Stock Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #3182f6;
      --danger: #ff3b30;
      --profit: #007aff;
      --bg: #f9fafb;
      --text: #1c1c1e;
      --gray: #a1a1aa;
    }

    body {
      margin: 0;
      font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }

    h2 {
      margin-bottom: 1rem;
      font-size: 1.8rem;
      color: var(--primary);
    }

    #proStatus {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      font-weight: 600;
      color: #10b981;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f0f4f8;
      color: #374151;
      font-weight: 600;
      font-size: 0.9rem;
    }

    td {
      font-size: 0.9rem;
    }

    .price-up {
      color: var(--danger);
      font-weight: 600;
    }

    .price-down {
      color: var(--profit);
      font-weight: 600;
    }

    .profit-up { color: var(--danger); font-weight: 600; }
    .profit-down { color: var(--profit); font-weight: 600; }

    .total-row {
      background: #f9fbfc;
      font-weight: 700;
    }

    .input-row input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      margin-top: 1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn + .btn {
      margin-left: 0.5rem;
    }

    canvas {
      margin-top: 2rem;
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <h2>📈 Stock Tracker</h2>

  <label for="password">🔐 Pro 모드 비밀번호:</label>
  <input type="password" id="password" placeholder="비밀번호 입력" style="margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px;">
  <div id="proStatus"></div>

  <table id="inputTable">
    <thead>
      <tr>
        <th>종목 코드</th>
        <th>보유 수량</th>
        <th>평균 단가</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody>
      <tr class="input-row">
        <td><input type="text" value="005930"></td>
        <td><input type="number" value="10"></td>
        <td><input type="number" value="70000"></td>
        <td><button onclick="removeRow(this)">❌</button></td>
      </tr>
      <tr class="input-row">
        <td><input type="text" value="035720"></td>
        <td><input type="number" value="5"></td>
        <td><input type="number" value="100000"></td>
        <td><button onclick="removeRow(this)">❌</button></td>
      </tr>
      <tr class="input-row">
        <td><input type="text" value="000660"></td>
        <td><input type="number" value="15"></td>
        <td><input type="number" value="120000"></td>
        <td><button onclick="removeRow(this)">❌</button></td>
      </tr>
    </tbody>
  </table>

  <div>
    <button class="btn" onclick="addRow()">➕ 행 추가</button>
    <button class="btn" onclick="startTracking()">📊 전체 조회</button>
  </div>

  <div id="output"></div>
  <canvas id="stockChart" height="100"></canvas>

  <script>
    const WORKER_URL = "https://jolly-hall-61f4.313nara.workers.dev/";
    const ctx = document.getElementById("stockChart").getContext("2d");

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "총 평가금액",
          borderColor: "#3182f6",
          backgroundColor: "rgba(49,130,246,0.1)",
          fill: true,
          data: []
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { display: true },
          y: { display: true }
        }
      }
    });

    let trackingStarted = false;
    let trackTimer = null;
    let stopTimer = null;

    function addRow() {
      const tbody = document.querySelector("#inputTable tbody");
      const row = document.createElement("tr");
      row.className = "input-row";
      row.innerHTML = `
        <td><input type="text"></td>
        <td><input type="number"></td>
        <td><input type="number"></td>
        <td><button onclick="removeRow(this)">❌</button></td>
      `;
      tbody.appendChild(row);
    }

    function removeRow(button) {
      button.closest("tr").remove();
    }

    async function verifyPassword(password) {
      try {
        const res = await fetch(WORKER_URL + "check-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        const result = await res.json();
        return result.ok === true;
      } catch {
        return false;
      }
    }

    async function startTracking() {
      if (trackingStarted) return;
      trackingStarted = true;

      const password = document.getElementById("password").value;
      const proStatus = document.getElementById("proStatus");
      const isPro = await verifyPassword(password);
      if (isPro) {
        localStorage.setItem("pro", "true");
        proStatus.textContent = "✅ Pro 모드로 진입했습니다 (30초 업데이트)";
      } else {
        proStatus.textContent = "⏳ 일반 모드로 실행 중입니다 (1분 업데이트)";
      }

      const interval = isPro ? 30000 : 60000;

      // 🔁 최초 1회는 즉시 실행
      await trackStocks();

      // 이후부터는 주기적으로 실행
      trackTimer = setInterval(trackStocks, interval);
      stopTimer = setTimeout(() => {
        clearInterval(trackTimer);
        alert("⏱️ 자동 업데이트가 종료되었습니다 (10분 경과)");
        trackingStarted = false;
        proStatus.textContent = "";
      }, 10 * 60 * 1000);
    }